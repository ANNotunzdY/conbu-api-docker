FROM ruby:2.4

MAINTAINER CONBU

RUN apt-get update -qq && apt-get install -y build-essential

ENV APP_HOME /app
RUN mkdir $APP_HOME
WORKDIR $APP_HOME

RUN git clone https://github.com/conbu/conbu-api-daemon

WORKDIR $APP_HOME/conbu-api-daemon

RUN bundle install

RUN mkdir /root/.pit
COPY default.yaml /root/.pit/

RUN sed -i -e s/zabbix\.conbu/zabbix3.conbu/g daemon

# allow acess from conbu-api-server
RUN sed -i -e "/start_service/i \ \ require \'drb/acl\'" daemon
RUN sed -i -e '/start_service/i \ \ acl = ACL.new(%w{allow all})' daemon
RUN sed -i -e '/start_service/i \ \ DRb.install_acl(acl)' daemon
RUN sed -i -e 's/localhost:8282/conbu-api-daemon:8282/g' daemon

# change settings according to conference
RUN sed -i -e 's/(AP-[0-9]{3})/(AP[0-9]{3})/g' daemon

CMD ["bundle", "exec", "ruby", "daemon"]

